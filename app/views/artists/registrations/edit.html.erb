<% content_for :title, "Edit Artist Account" %>

<style>
  .required abbr { display: none; }
  .hint { display: none !important; }
  .custom-required::before {
    content: "* ";
    color: red;
  }

  .cropper-crop-box,
  .cropper-view-box {
    border-radius: 50% !important;
  }
</style>

<div class="container my-4" style="max-width: 550px;">
  <div class="card shadow-sm">
    <div class="card-body">

      <%= simple_form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, multipart: true }) do |f| %>
        <%= f.error_notification %>

        <div class="mb-3">
          <%= f.input :firstname, label: "First Name", input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :lastname, label: "Last Name", input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :username, label: "Display Name", input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :genre, collection: Artist::GENRES, input_html: { class: "form-select" }, label_html: { class: "form-label" }, prompt: false %>
        </div>

        <div class="mb-3">
          <%= f.input :performance_type, label: "Type", collection: Artist::PERFORMANCE_TYPES, input_html: { class: "form-select" }, label_html: { class: "form-label" }, prompt: false %>
        </div>

        <div class="mb-3">
          <%= f.input :website, input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :instagram_url, label: "Instagram URL", input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :youtube_url, label: "YouTube URL", input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :tiktok_url, label: "TikTok URL", input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :spotify_url, label: "Spotify URL", input_html: { class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <!-- Profile Photo Cropper -->
<div class="mb-3" data-controller="cropper">
  <%= f.label :image, "Profile Photo", class: "form-label" %>

  <!-- Show current image if attached -->
  <% if resource.image.attached? %>
    <div class="mb-2">
      <%= image_tag resource.image.variant(resize_to_limit: [300, 300]),
          class: "img-thumbnail rounded-circle border border-light shadow-sm",
          style: "width: 160px; height: 160px; object-fit: cover;" %>
    </div>
  <% end %>

  <!-- Upload new image -->
  <%= f.file_field :image,
      accept: "image/jpeg,image/png",
      class: "form-control",
      data: { "cropper-target": "input", action: "change->cropper#previewImage" } %>

  <!-- Cropper live preview -->
  <div class="mt-3 d-flex justify-content-center">
    <img data-cropper-target="preview"
         class="img-thumbnail d-none"
         style="max-width: 300px; border-radius: 50%;" />
  </div>

  <!-- Final preview label -->
  <div class="text-center mt-4 d-none" id="cropped-preview-label">
    <p class="fw-semibold mb-1">How your image will show on your profile</p>
  </div>

  <!-- Final cropped preview -->
  <div class="text-center">
    <img
      id="cropper-preview-result"
      src=""
      class="d-none rounded-circle border border-white"
      style="width: 160px; height: 160px; object-fit: cover; box-shadow: 0 20px 40px rgba(0,0,0,0.3);"
      alt="Cropped preview"
    />
  </div>

  <!-- Save button -->
  <div class="text-center mt-3">
    <button type="button"
            class="btn btn-sm btn-outline-primary d-none"
            data-cropper-target="saveButton"
            data-action="click->cropper#cropAndReplace">
      Save
    </button>
  </div>
</div>

        <div class="mb-3" data-controller="character-counter" data-character-counter-max-value="140">
          <%= f.input :bio, 
              label: "About Me", 
              as: :text,
              input_html: { 
                class: "form-control form-control-lg", 
                rows: 4,
                maxlength: 140,
                placeholder: "Tell fans about your music style, influences, and what makes your performances special...",
                data: { action: "input->character-counter#input" }
              },
              label_html: { class: "form-label fw-medium" },
              wrapper: false,
              hint: false %>
          <div class="form-text d-flex justify-content-between">
            <span>Brief description of your music and style</span>
            <span data-character-counter-target="count">0/140</span>
          </div>
        </div>

        <div class="mb-3">
          <%= f.input :email, required: true, autofocus: true, hint: false, input_html: { class: "form-control" }, label_html: { class: "form-label custom-required" } %>
        </div>

        <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
          <p class="text-muted small mb-3">
            Waiting confirmation for: <strong><%= resource.unconfirmed_email %></strong>
          </p>
        <% end %>

        <div class="mb-3">
          <%= f.input :password, label: "New Password", required: false, hint: false, input_html: { autocomplete: "new-password", class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :password_confirmation, label: "Confirm New Password", required: false, hint: false, input_html: { autocomplete: "new-password", class: "form-control" }, label_html: { class: "form-label" } %>
        </div>

        <div class="mb-3">
          <%= f.input :current_password, required: true, hint: false, input_html: { autocomplete: "current-password", class: "form-control" }, label_html: { class: "form-label custom-required" } %>
        </div>

        <div class="d-grid gap-2">
          <%= f.button :submit, "Update Account", class: "btn btn-primary" %>
        </div>
      <% end %>

      <hr class="my-4">

      <div class="text-center">
        <h6>Cancel Account</h6>
        <p class="text-muted small">Unhappy? You can delete your account below.</p>
        <%= button_to "Cancel my account", registration_path(resource_name), method: :delete, data: { confirm: "Are you sure?" }, class: "btn btn-outline-danger btn-sm" %>
      </div>
    </div>
  </div>
</div>
