<% content_for :title, "Upcoming Events Near You" %>

<div class="min-vh-100 bg-light">
  <div class="container py-4" style="max-width: 600px;">

    <!-- Collapsible Search Section -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4">
      <div class="card-header bg-white border-0 p-3">
        <button class="btn btn-link text-decoration-none p-0 w-100 text-center d-flex justify-content-center align-items-center"
                type="button"
                onclick="toggleSearchForm()"
                id="searchToggleBtn">
          <span class="fw-medium text-dark">üîç Search & Filter Events</span>
          <span class="text-muted position-absolute end-0 me-3" id="chevronIcon">‚ñº</span>
        </button>
      </div>

      <div class="collapse" id="searchForm" style="display: none;">
        <div class="card-body p-4 pt-0 text-start">

          <%= form_with url: events_path, method: :get, local: false,
                        data: {
                          controller: "location-search",
                          "location-search-current-lat-value": params[:lat],
                          "location-search-current-lng-value": params[:lng],
                          "location-search-current-address-value": params[:address],
                          "location-search-current-radius-value": params[:radius] || 5,
                          turbo_frame: "events-container"
                        } do |f| %>

            <!-- Location -->
            <div class="mb-3">
              <label class="form-label small text-muted">Location</label>

              <div class="form-check mb-2">
                <%= radio_button_tag :location_type, "address", true,
                      class: "form-check-input",
                      data: { "location-search-target": "addressRadio" } %>
                <%= label_tag :location_type_address, "Enter address", class: "form-check-label" %>
              </div>

              <%= f.text_field :address,
                    placeholder: "Enter address or ZIP code",
                    class: "form-control",
                    value: params[:address],
                    data: { "location-search-target": "addressInput" } %>

              <div class="form-check mt-2">
                <%= radio_button_tag :location_type, "current", false,
                      class: "form-check-input",
                      data: { "location-search-target": "currentRadio", action: "change->location-search#getCurrentLocation" } %>
                <%= label_tag :location_type_current, "Use my current location", class: "form-check-label" %>
              </div>
            </div>

            <!-- Radius -->
            <div class="mb-3">
              <%= f.label :radius, "Search Radius", class: "form-label small text-muted" %>
              <%= f.select :radius,
                    options_for_select([
                      ['1 mi', 1], ['5 mi', 5], ['10 mi', 10],
                      #['15 mi', 15], ['25 mi', 25], ['50 mi', 50]
                    ], params[:radius] || 1),
                    {},
                    class: "form-select",
                    data: {
                      action: (params[:address].present? || params[:lat].present?) ? "change->location-search#autoSubmit" : ""
                    } %>
            </div>

            <!-- Date Range -->
            <div class="mb-3">
              <%= f.label :date_range, "Show events for", class: "form-label small text-muted" %>
              <%= f.select :date_range,
                    options_for_select([
                      ["Any Date", ""],
                      ["Today", "today"],
                      ["Next 7 Days", "next_7_days"]
                    ], params[:date_range]),
                    {},
                    class: "form-select",
                    data: {
                      action: (params[:address].present? || params[:lat].present?) ? "change->location-search#autoSubmit" : ""
                    } %>
            </div>

            <!-- Sort By -->
            <div class="mb-3">
              <%= f.label :sort_by, "Sort by", class: "form-label small text-muted" %>
              <%= f.select :sort_by,
                    options_for_select([
                      ["Soonest First", "date"],
                      ["Closest First", "distance"]
                    ], params[:sort_by] || "date"),
                    {},
                    class: "form-select",
                    data: {
                      action: (params[:address].present? || params[:lat].present?) ? "change->location-search#autoSubmit" : ""
                    } %>
            </div>

            <!-- Error message -->
            <div id="location-error" class="alert alert-danger d-none mb-3" role="alert">
              Please enter an address or use your current location before searching.
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm">
              Search Events
            </button>

            <%= f.hidden_field :lat, data: { "location-search-target": "latInput" } %>
            <%= f.hidden_field :lng, data: { "location-search-target": "lngInput" } %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Search Summary -->
    <%= turbo_frame_tag "events-container" do %>
      <% if params[:address].present? || params[:lat].present? || params[:date_range].present? %>
        <div class="card mb-3 shadow-sm border-0 rounded-4 text-center">
          <div class="card-body py-2">
            <small class="text-muted">
              <% if params[:address].present? %>
                Found  <% if @events.respond_to?(:count) %>
                  <%= pluralize(@events.count, 'event') %> within
                  <%= params[:radius] || 5 %> miles of "<%= params[:address] %>"

                <% elsif params[:lat].present? %>
                  Found <% if @events.respond_to?(:count) %>
                    <%= pluralize(@events.count, 'event') %> within
                    <%= params[:radius] || 5 %> miles of your location
                  <% end %>
                <% end %>

              <% end %>
            </small>
          </div>
        </div>
      <% end %>

      <!-- Events List or Empty State -->
      <% if @events&.any? %>
        <%= render partial: "events", collection: @events %>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-calendar-x" style="font-size: 3rem; color: #6c757d;"></i>
          <h5 class="mt-3 text-muted">No events found</h5>
          <p class="text-muted">
            <% if params[:address].present? || params[:lat].present? || params[:date_range].present? %>
              Try expanding your search radius, location, or date range.
            <% else %>
              Check back soon for upcoming events!
            <% end %>
          </p>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<!-- Back to top button -->
<button id="backToTop" onclick="scrollToTop()" style="
  position: fixed;
  bottom: 5px;
  right: 5px;
  padding: 10px 12px;
  border: none;
  background: rgba(102, 126, 234, 0.9);
  color: white;
  border-radius: 50%;
  font-size: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 1000;
  display: none;
">
  ‚Üë
</button>

<script>
  function toggleSearchForm() {
    const form    = document.getElementById('searchForm');
    const chevron = document.getElementById('chevronIcon');
    const isOpen  = form.style.display === 'block';
    form.style.display = isOpen ? 'none' : 'block';
    chevron.textContent = isOpen ? '‚ñº' : '‚ñ≤';
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.addEventListener("scroll", function () {
    const btn = document.getElementById("backToTop");
    btn.style.display = window.scrollY > 300 ? "block" : "none";
  });
</script>
